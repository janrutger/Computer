#### From here game development starts ####



INCLUDE game_lib

# First item : tile width
# Second item: tile height
# spritedata Width x Height, where 0 is the no-sprite and so the transparant sprite
# 
LIST tile_data0 10      ; First tile data
ASM {
   # % $tile_data 1 4 56 50 0 54  ; where 0 is transparent
    % $tile_data0 2 4  129 130  91 93  91 93  203 203
}
&tile_data0 AS tile   ; the pointer to the tile 


LIST tile_data1 11      ; Second tile data
ASM {
    % $tile_data1 3 3 203 203 203 203 0 203 203 203 203
}
&tile_data1 AS tile1


LIST tile_data2 6      ; Third tile data
ASM {
    # % $tile_data2 2 2 42 42 42 42 
    % $tile_data2 1 1 42 
}
&tile_data2 AS tile2

# Main function
DEF main {
    # IO 2 ONLINE
    # IO 2 NEW
    # 3 IO 2 MODE     # doublebuffer sprite mode

    init_game_lib

    # --- Define Replacement Data ---
    # This structure defines what a tile turns into when replaced.
    # Format: [new_tile_data_ptr, new_color, new_reaction]
    LIST locked_door_replacement 3
    &locked_door_replacement &tile_data2 green REACT_BLOCK define_replacement

    # Initialize event variables to -1 (no event)
    # 1 _negate AS EVENT_TYPE
    # 1 _negate AS EVENT_TARGET
    # 1 _negate AS EVENT_ACTOR
    # 1 _negate AS EVENT_POTENTIAL_X
    # 1 _negate AS EVENT_POTENTIAL_Y

    # Initialize our two tiles, expects argumnt on the stack
    # [ tile_id, start_x, start_y, data_ptr, color, reaction, replace_ptr ]
    0 40 30 tile  orange       REACT_REPLACE   &locked_door_replacement GAME.init_tile    # Tile 0 is a "locked door"
    # 0 40 30 tile  orange       REACT_BLOCK     0 GAME.init_tile    
    # 0 40 30 tile  orange       REACT_OVERWRITE 0 GAME.init_tile    # Tile 0 is a "locked door"

    1 20 30 tile1 purple       REACT_BLOCK     0                         GAME.init_tile    # Tile 1 is the player

    2 40 40 tile2 blue         REACT_OVERWRITE 0                         GAME.init_tile

    3 AS active_tile_count      ; We have initialized 2 tiles
    1 AS KEYBOARD_TILE          ; set the player Tile

    # Perform the initial draw of all tiles
    # draw_all_tiles
    0 draw_tile_by_id
    1 draw_tile_by_id
    2 draw_tile_by_id
    GAME.refresh
    
    
    # Example of deleting tile 0
    # 0 delete_tile

    # --- Game Developer's variables for a patrol sequence ---
    750  AS timer_0_time      # Wait N frames between moves
    0    AS timer_0           # The state variable for our patrol timer
    0    AS timer_0_state     # 0 means 'even', 1 means means 'odd' (False/True)

    # ------------------------------------------------------------------
    # Main Game Loop (The "Game Developer's Script")
    # ------------------------------------------------------------------
    1 AS running
    WHILE running DO
        # Ask the timer function if it's time to make a move.
        # We pass a pointer to our specific timer variable.
        &timer_0 timer_0_time is_timer_ready IF
            # is_timer_ready returned 1, so we are "informed" it's time to act.
            # The game developer's logic to calculate the next move goes here.
            timer_0_state IF
                # We are in state 1, move back to original position
                40 30 0 tile_move
                0 AS timer_0_state # Switch to state 0 for next time
            ELSE
                # We are in state 0, move to a new position
                10 10 0 tile_move
                1 AS timer_0_state # Switch to state 1 for next time
            END
        END

        GAME.handle_input          # 1. Senses: Get a raw physics report.
        GAME.process_events        # 2. Mechanics: Execute mechanics and get a factual report.

        # 3. Logic: Apply game rules based on the factual report.
        AS interacted_id
        AS game_event

        game_event GAME_EVENT_OVERWRITE_ACTION == IF
            # Rule: An object was overwritten. What does this mean for the game?
            # The game developer knows that tile 0 is a coin.
            interacted_id 0 == IF
                # It was the coin! Increment the score.
                score 1 + AS score
            END
        ELSE game_event GAME_EVENT_BLOCK_ACTION == IF
            # Rule: An object was blocked. What does this mean for the game?
            # The game developer knows that tile 0 is a wall.
            interacted_id 0 == IF
                score 1 + AS score
            END
        ELSE game_event GAME_EVENT_REPLACE_ACTION == IF
            # Rule: An object was replaced. What does this mean for the game?
            # The game developer knows that tile 0 is a locked door.
            interacted_id 0 == IF
                score 1 + AS score
            END
        END END END

        GAME.redraw_all_moved_tiles # 4. Hands: Update the screen.

    DONE
}

main
score PRINT