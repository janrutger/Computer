# ============================================================================
# Multi layer perceptron test code
# ============================================================================

USE std_heap
USE std_stern_io
USE std_time
USE std_stacks_rt

INCLUDE math_lib
INCLUDE fixed_point_lib

INCLUDE mlnn_lib

VALUE network_ptr 0
VALUE hidden_layer_ptr 0
VALUE output_layer_ptr 0
VALUE input_array_ptr 0
VALUE output_array_ptr 0





DEF SRAND {
    *p_currentime rand_m % AS random_seed
    "New random seed: " PRTstring
    random_seed PRINT
}



# ============================================================================
# Main Program
# ============================================================================

# --- 1. Initialization ---
# HEAP_MEM_START HEAP_MEM_SIZE HEAP.init
HEAP.free
SRAND    

"--- Phase 1: Testing NN.new_network ---\n" PRTstring
"Creating a 2-2-1 network...\n" PRTstring

2 2 1 NN.new_network AS network_ptr

"Network created at address: " PRTstring
network_ptr PRINT

"Verifying network structure...\n" PRTstring

# Get pointers from the main network array
network_ptr 1 ARRAY.get AS hidden_layer_ptr
network_ptr 2 ARRAY.get AS output_layer_ptr

"  Input size: " PRTstring
network_ptr 0 ARRAY.get PRINT

"  Hidden layer pointer: " PRTstring
hidden_layer_ptr PRINT

"  Output layer pointer: " PRTstring
output_layer_ptr PRINT

"  Hidden layer neuron count: " PRTstring
hidden_layer_ptr ARRAY.len PRINT

"  Output layer neuron count: " PRTstring
output_layer_ptr ARRAY.len PRINT

"\n--- Phase 2: Testing NN.predict ---\n" PRTstring

"Creating input array [1.0, 0.0]...\n" PRTstring
2 NEW.array AS input_array_ptr
1 FP.from_int input_array_ptr ARRAY.append
0 FP.from_int input_array_ptr ARRAY.append

"Running prediction...\n" PRTstring
network_ptr input_array_ptr NN.predict AS output_array_ptr

"Prediction finished. Output pointer: " PRTstring
output_array_ptr PRINT

"Output array length: " PRTstring
output_array_ptr ARRAY.len PRINT

"Predicted value (random weights): " PRTstring
# Since our network has 1 output neuron, the result is at index 0
0 output_array_ptr ARRAY.get FP.print


"\nALL DONE... \n" PRTstring


"\n--- Phase 2b: Deterministic Prediction Test ---\n" PRTstring

# Manually set weights and biases for predictable output
# All weights = 0.5 (500), all biases = 0.1 (100)

"Setting weights to 0.5 and biases to 0.1...\n" PRTstring

# Hidden Layer (2 neurons)
0 hidden_layer_ptr ARRAY.get AS _nn_perceptron_ptr
100 0 _nn_perceptron_ptr ARRAY.put # Set bias for H0
500 0 _nn_perceptron_ptr _NN.set_weight
500 1 _nn_perceptron_ptr _NN.set_weight

1 hidden_layer_ptr ARRAY.get AS _nn_perceptron_ptr
100 0 _nn_perceptron_ptr ARRAY.put # Set bias for H1
500 0 _nn_perceptron_ptr _NN.set_weight
500 1 _nn_perceptron_ptr _NN.set_weight

# Output Layer (1 neuron)
0 output_layer_ptr ARRAY.get AS _nn_perceptron_ptr
100 0 _nn_perceptron_ptr ARRAY.put # Set bias for O0
500 0 _nn_perceptron_ptr _NN.set_weight
500 1 _nn_perceptron_ptr _NN.set_weight

"Running prediction with known weights...\n" PRTstring
network_ptr input_array_ptr NN.predict AS output_array_ptr

"Predicted value (known weights): " PRTstring
0 output_array_ptr ARRAY.get FP.print

"\nExpected output calculation:\n" PRTstring
"  Input: [1.0, 0.0]\n" PRTstring
"  H0_out = relu(1.0*0.5 + 0.0*0.5 + 0.1) = relu(0.6) = 0.6\n" PRTstring
"  H1_out = relu(1.0*0.5 + 0.0*0.5 + 0.1) = relu(0.6) = 0.6\n" PRTstring
"  O0_out = relu(0.6*0.5 + 0.6*0.5 + 0.1) = relu(0.3 + 0.3 + 0.1)\n" PRTstring
"         = relu(0.7) = 0.7\n \n Expected prediction: 0.700\n" PRTstring


"\nALL DONE... \n" PRTstring